# Project Plan: Code Machine Orchestrator

**Version:** 1.0
**Date:** November 18, 2025
**Generated By:** AI Software Architect (Model V2)

## 1. Project Overview

*   **Goal:** Develop a Visual Studio Code Extension that serves as an interactive GUI wrapper for the "Type A" Python CLI, enforcing a "Human-in-the-Loop" workflow for AI code generation.
*   **High-Level Requirements Summary:**
    *   **Control Center:** Dedicated Activity Bar and Sidebar for project state management.
    *   **Phase Management:** Visual gating for Specifications, Architecture, Planning, and Building phases.
    *   **Interactive Artifacts:** Webview for prompting, Mermaid rendering for architecture, and interactive Tree View for task plans (`todo.json`).
    *   **Granular Build Control:** Step-by-step CLI execution with "Diff-Review" (Accept/Reject/Retry) capabilities via Git integration.
    *   **QA Integration:** Visualization of test results and logs within the UI.
*   **Key Assumptions:**
    *   The target "Type A" Python CLI is available in the system PATH or a configurable location.
    *   The user's workspace is initialized as a Git repository (or the CLI handles initialization).
    *   VS Code API capabilities (Webviews, TreeView, FileSystemWatcher) are sufficient for the required UX.
    *   A `mock_cli.py` will be created during development to simulate the backend behavior for testing the extension logic.

## 2. Core Architecture

*   **Architectural Style:** Event-Driven Client-Wrapper (Local). The extension acts as a stateful UI observer over a resource-oriented file system state managed by a stateless CLI.
*   **Technology Stack:**
    *   **Frontend (UI):** TypeScript (VS Code Extension API), React (for complex Webviews like the Prompt Wizard), Mermaid.js (Diagram rendering).
    *   **Backend (Logic):** TypeScript (Node.js runtime included in VS Code).
    *   **External Engine:** Python 3.x (The "Type A" CLI - External Dependency).
    *   **Data/State:** JSON (`todo.json`), Markdown (`requirements.md`, `architecture.md`), Git (Version Control).
    *   **Deployment:** VS Code Marketplace (`.vsix`).
*   **Key Components/Services:**
    *   **WorkflowController:** Manages the state machine (Phases) and user interactions.
    *   **CliService:** Handles `child_process` spawning, stdout parsing, and error handling for the Python CLI.
    *   **GitService:** Manages git operations (commit, reset, diff) for the review loop.
    *   **ArtifactWatcher:** Listens for file system changes to trigger UI hot-reloads.
    *   **Views:** `ProjectSidebarProvider` (Tree View), `PromptPanel` (Webview).
*   **Data Model Overview:**
    *   **Task Tree:** Hierarchical JSON structure (`todo.json`) representing Iterations and Tasks.
    *   **Project State:** In-memory context synced with file existence (e.g., if `requirements.md` exists, Phase > Specs).
*   **API Contract Style:**
    *   **Internal:** TypeScript Interfaces / Classes.
    *   **External:** CLI Arguments (Standard Shell) and File System Events.
*   **Communication Patterns:**
    *   **Async Command:** Extension -> CLI (Spawn Process).
    *   **Event:** File System -> Extension (Watcher triggers UI refresh).

## 2.1. Key Architectural Artifacts Planned

*   **System Component Diagram (PlantUML):** To visualize the interaction between VS Code Components, the Workflow Controller, and the External CLI/FS. (Created in I1.T2)
*   **Workflow State Machine Diagram (Mermaid):** To define the valid transitions between Concept, Specs, Arch, Plan, and Build phases. (Created in I2.T1)
*   **Task Data Schema (JSON Schema):** To strictly define the structure of `todo.json` for validation and UI rendering. (Created in I4.T1)
*   **Build Loop Sequence Diagram (PlantUML):** To detail the complex interaction of "Run Step -> Git Commit -> Show Diff -> User Action -> Revert/Proceed". (Created in I5.T1)

## 3. Directory Structure

*   **Root Directory:** `codemachine-vscode/`
*   **Structure Definition:**
    ~~~
    codemachine-vscode/
    ├── .vscode/               # Launch configs for debugging the extension
    ├── assets/                # Icons and static images
    ├── src/
    │   ├── commands/          # Command Palette registrations
    │   ├── controllers/       # Business logic (Workflow, Review logic)
    │   ├── models/            # TypeScript interfaces (Task, State)
    │   ├── services/          # External interactions (CLI, Git, FS)
    │   ├── views/             # UI Components
    │   │   ├── sidebar/       # TreeDataProvider implementations
    │   │   └── webviews/      # React/HTML content for panels
    │   ├── utils/             # Helpers (Path parsing, formatting)
    │   └── extension.ts       # Entry point
    ├── docs/
    │   ├── diagrams/          # PlantUML and Mermaid source files
    │   └── adr/               # Architectural Decision Records
    ├── schemas/               # JSON Schemas for validation
    ├── test/                  # Unit and Integration tests
    │   └── mocks/             # Mock CLI scripts for testing
    ├── package.json           # Manifest and dependencies
    ├── tsconfig.json
    └── README.md
    ~~~

## 4. Iteration Plan

*   **Total Iterations Planned:** 6
*   **Iteration Dependencies:** Sequential execution is recommended. I1 builds the foundation. I2 establishes the UI shell. I3-I5 implement the specific phases. I6 adds the complex review logic.

---

### Iteration 1: Foundation & Core Services

*   **Iteration ID:** `I1`
*   **Goal:** Initialize the project, set up the extension manifest, implement the core CLI wrapper service, and define the high-level architecture.
*   **Prerequisites:** None
*   **Tasks:**
    *   **Task 1.1:**
        *   **Task ID:** `I1.T1`
        *   **Description:** Initialize VS Code Extension project structure using `yo code` (or manual setup) with TypeScript. Configure `package.json` with basic activation events and the "Code Machine" output channel.
        *   **Agent Type Hint:** `SetupAgent`
        *   **Inputs:** Project Name "Code Machine Orchestrator".
        *   **Input Files:** []
        *   **Target Files:** `package.json`, `src/extension.ts`, `tsconfig.json`
        *   **Deliverables:** Initialized project repository.
        *   **Acceptance Criteria:** Extension compiles and runs in "Extension Development Host". "Code Machine" output channel is visible.
        *   **Dependencies:** None
        *   **Parallelizable:** No
    *   **Task 1.2:**
        *   **Task ID:** `I1.T2`
        *   **Description:** Generate a System Component Diagram showing the Extension, Workflow Controller, CLI Wrapper, and File System interactions.
        *   **Agent Type Hint:** `DiagrammingAgent`
        *   **Inputs:** Section 2 (Core Architecture).
        *   **Input Files:** []
        *   **Target Files:** `docs/diagrams/system_component.puml`
        *   **Deliverables:** PlantUML diagram file.
        *   **Acceptance Criteria:** Diagram clearly separates UI, Logic, and External CLI. Renders without syntax errors.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes
    *   **Task 1.3:**
        *   **Task ID:** `I1.T3`
        *   **Description:** Implement `CliService`. This class should handle spawning a child process, returning a Promise that resolves on exit code 0, and streaming stdout to the Output Channel. Include a `MockCli.py` in `test/mocks` that accepts arguments and sleeps/prints to simulate work.
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 5.4 (CLI Integration Wrapper).
        *   **Input Files:** `src/extension.ts`
        *   **Target Files:** `src/services/CliService.ts`, `test/mocks/mock_cli.py`
        *   **Deliverables:** TypeScript service class and Python mock script.
        *   **Acceptance Criteria:** Unit test confirms `CliService` can run `mock_cli.py` and capture output.
        *   **Dependencies:** I1.T1
        *   **Parallelizable:** No

---

### Iteration 2: The Control Center (UI Shell)

*   **Iteration ID:** `I2`
*   **Goal:** Implement the Activity Bar container, the Sidebar layout, and the State Machine logic to track the project phase.
*   **Prerequisites:** `I1`
*   **Tasks:**
    *   **Task 2.1:**
        *   **Task ID:** `I2.T1`
        *   **Description:** Generate a State Machine Diagram defining transitions: Concept -> Specs -> Arch -> Plan -> Build. Define triggers (e.g., "Approve Specs").
        *   **Agent Type Hint:** `DiagrammingAgent`
        *   **Inputs:** Requirement 3.1 (Project State).
        *   **Input Files:** []
        *   **Target Files:** `docs/diagrams/workflow_state.mmd`
        *   **Deliverables:** Mermaid diagram file.
        *   **Acceptance Criteria:** Covers all 5 phases and "Gating" transitions.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes
    *   **Task 2.2:**
        *   **Task ID:** `I2.T2`
        *   **Description:** Update `package.json` to contribute a View Container (Activity Bar) and three Views (Project State, Task Board, Artifacts). Implement a basic `WorkflowController` that holds the current phase state.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.1.
        *   **Input Files:** `package.json`, `docs/diagrams/workflow_state.mmd`
        *   **Target Files:** `package.json`, `src/controllers/WorkflowController.ts`
        *   **Deliverables:** Updated manifest and controller logic.
        *   **Acceptance Criteria:** The "Code Machine" icon appears in the sidebar. Three empty views are visible.
        *   **Dependencies:** I1.T1
        *   **Parallelizable:** No
    *   **Task 2.3:**
        *   **Task ID:** `I2.T3`
        *   **Description:** Implement `ArtifactWatcher`. Use `vscode.workspace.createFileSystemWatcher` to monitor `artifacts/*.{md,json}`. When files change, emit an event to the `WorkflowController` to update the state (e.g., if `requirements.md` is created, move phase to Specs).
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 5.3 (Data Watching).
        *   **Input Files:** `src/controllers/WorkflowController.ts`
        *   **Target Files:** `src/services/ArtifactWatcher.ts`
        *   **Deliverables:** Watcher service.
        *   **Acceptance Criteria:** Creating a dummy file in `artifacts/` triggers a log message in the extension.
        *   **Dependencies:** I2.T2
        *   **Parallelizable:** No

---

### Iteration 3: Phases 1 & 2 (Specs & Architecture)

*   **Iteration ID:** `I3`
*   **Goal:** Implement the Prompt Wizard (Webview) and the Architecture Preview with Mermaid rendering.
*   **Prerequisites:** `I2`
*   **Tasks:**
    *   **Task 3.1:**
        *   **Task ID:** `I3.T1`
        *   **Description:** Create the "New Project" command and Webview. The Webview should accept a Project Name and Prompt, then call `CliService` (mocked) to generate `requirements.md`.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.2 (Phase 1).
        *   **Input Files:** `src/services/CliService.ts`
        *   **Target Files:** `src/views/webviews/PromptPanel.ts`, `src/commands/newProject.ts`
        *   **Deliverables:** Interactive Webview form.
        *   **Acceptance Criteria:** Submitting the form triggers the CLI and opens `requirements.md` in the editor.
        *   **Dependencies:** I1.T3
        *   **Parallelizable:** No
    *   **Task 3.2:**
        *   **Task ID:** `I3.T2`
        *   **Description:** Implement the Architecture Preview logic. Create a command that parses `architecture.md`, extracts Mermaid blocks, and renders them in a VS Code Webview Panel alongside the text.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.3 (Phase 2).
        *   **Input Files:** `src/controllers/WorkflowController.ts`
        *   **Target Files:** `src/views/webviews/ArchitecturePreview.ts`
        *   **Deliverables:** Preview logic using Mermaid.js CDN or bundled library.
        *   **Acceptance Criteria:** Opening a markdown file with mermaid blocks and running the command renders the diagram visually.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes

---

### Iteration 4: Phase 3 (The Plan Board)

*   **Iteration ID:** `I4`
*   **Goal:** Implement the interactive Tree View for `todo.json` allowing visualization and manipulation of the build plan.
*   **Prerequisites:** `I2`
*   **Tasks:**
    *   **Task 4.1:**
        *   **Task ID:** `I4.T1`
        *   **Description:** Define the JSON Schema for `todo.json`. It must support nested iterations and tasks with status, id, and dependencies.
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 3.4 (Plan Board).
        *   **Input Files:** []
        *   **Target Files:** `schemas/todo_schema.json`
        *   **Deliverables:** JSON Schema file.
        *   **Acceptance Criteria:** Validates a sample `todo.json` correctly.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes
    *   **Task 4.2:**
        *   **Task ID:** `I4.T2`
        *   **Description:** Implement `TaskTreeProvider` implementing `vscode.TreeDataProvider`. It should read `todo.json` and render Iterations as collapsible nodes and Tasks as leaf nodes.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.4, `schemas/todo_schema.json`.
        *   **Input Files:** `schemas/todo_schema.json`
        *   **Target Files:** `src/views/sidebar/TaskTreeProvider.ts`
        *   **Deliverables:** Tree View implementation.
        *   **Acceptance Criteria:** The "Task Board" view in the sidebar populates with data from a sample `todo.json`.
        *   **Dependencies:** I4.T1
        *   **Parallelizable:** No
    *   **Task 4.3:**
        *   **Task ID:** `I4.T3`
        *   **Description:** Implement "Approve Plan" command. This updates the `WorkflowController` state to "Build" and enables the execution controls.
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 3.4 (Approval).
        *   **Input Files:** `src/controllers/WorkflowController.ts`
        *   **Target Files:** `src/commands/approvePlan.ts`
        *   **Deliverables:** Command registration.
        *   **Acceptance Criteria:** Clicking approve changes the status indicator in the sidebar.
        *   **Dependencies:** I2.T2
        *   **Parallelizable:** Yes

---

### Iteration 5: Phase 4 (The Build Loop - Core)

*   **Iteration ID:** `I5`
*   **Goal:** Implement the granular execution of tasks using the CLI and basic Git integration.
*   **Prerequisites:** `I4`
*   **Tasks:**
    *   **Task 5.1:**
        *   **Task ID:** `I5.T1`
        *   **Description:** Generate a Sequence Diagram for the Build Loop. Show: User clicks "Run Task" -> Extension calls CLI -> CLI writes code -> Extension calls Git -> Extension opens Diff.
        *   **Agent Type Hint:** `DiagrammingAgent`
        *   **Inputs:** Requirement 3.5 (Iterative Build).
        *   **Input Files:** []
        *   **Target Files:** `docs/diagrams/build_loop_sequence.puml`
        *   **Deliverables:** PlantUML sequence diagram.
        *   **Acceptance Criteria:** Clearly shows the interaction between `CliService` and `GitService`.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes
    *   **Task 5.2:**
        *   **Task ID:** `I5.T2`
        *   **Description:** Implement `GitService`. Wrapper around `simple-git` or shell commands. Needs methods: `commit(msg)`, `resetHard()`, `getDiff()`, `init()`.
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 4.5.
        *   **Input Files:** []
        *   **Target Files:** `src/services/GitService.ts`
        *   **Deliverables:** Git service class.
        *   **Acceptance Criteria:** Unit tests verify it can commit and reset a test repo.
        *   **Dependencies:** None
        *   **Parallelizable:** Yes
    *   **Task 5.3:**
        *   **Task ID:** `I5.T3`
        *   **Description:** Implement `runTask` command. It should take a `taskId`, call `CliService.run(taskId)`, and upon success, trigger `GitService` to stage changes (but not commit yet, or commit to a temp branch depending on strategy).
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 5.4.
        *   **Input Files:** `src/services/CliService.ts`, `src/services/GitService.ts`
        *   **Target Files:** `src/controllers/BuildController.ts`
        *   **Deliverables:** Logic to run a specific task.
        *   **Acceptance Criteria:** Running a task triggers the mock CLI and results in a git status change.
        *   **Dependencies:** I1.T3, I5.T2
        *   **Parallelizable:** No

---

### Iteration 6: Phase 4 & 5 (Review Logic & QA)

*   **Iteration ID:** `I6`
*   **Goal:** Implement the "Diff Review" UI (Accept/Reject/Retry) and the QA status visualization.
*   **Prerequisites:** `I5`
*   **Tasks:**
    *   **Task 6.1:**
        *   **Task ID:** `I6.T1`
        *   **Description:** Implement the "Diff View" trigger. When a task finishes, use `vscode.commands.executeCommand('git.openChange', ...)` to show the diff of the generated files.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.5.
        *   **Input Files:** `src/controllers/BuildController.ts`
        *   **Target Files:** `src/controllers/ReviewController.ts`
        *   **Deliverables:** Logic to open the native VS Code diff editor.
        *   **Acceptance Criteria:** After `runTask` completes, the editor splits and shows the diff.
        *   **Dependencies:** I5.T3
        *   **Parallelizable:** No
    *   **Task 6.2:**
        *   **Task ID:** `I6.T2`
        *   **Description:** Implement "Accept" and "Reject" commands. "Accept" marks the task done in `todo.json`. "Reject" calls `GitService.resetHard()` and prompts the user for feedback (Input Box), then re-triggers `CliService` with the feedback.
        *   **Agent Type Hint:** `BackendAgent`
        *   **Inputs:** Requirement 3.5 (The Diff UX).
        *   **Input Files:** `src/controllers/ReviewController.ts`, `src/services/GitService.ts`
        *   **Target Files:** `src/commands/reviewCommands.ts`
        *   **Deliverables:** Command logic for review actions.
        *   **Acceptance Criteria:** Rejecting reverts the file system to pre-task state.
        *   **Dependencies:** I6.T1
        *   **Parallelizable:** No
    *   **Task 6.3:**
        *   **Task ID:** `I6.T3`
        *   **Description:** Implement QA Status Badges. Update `TaskTreeProvider` to read `logs/<taskId>.log` (mocked) or CLI exit codes to determine status (Green/Red). Add decoration to the TreeItem.
        *   **Agent Type Hint:** `FrontendAgent`
        *   **Inputs:** Requirement 3.6 (QA Dashboard).
        *   **Input Files:** `src/views/sidebar/TaskTreeProvider.ts`
        *   **Target Files:** `src/views/sidebar/TaskTreeProvider.ts`
        *   **Deliverables:** Visual badges on tree items.
        *   **Acceptance Criteria:** Tasks show checkmarks or X icons based on status in `todo.json`.
        *   **Dependencies:** I4.T2
        *   **Parallelizable:** Yes

## 5. Verification and Integration Strategy

*   **Testing Levels:**
    *   **Unit Tests:** Jest/Mocha for `CliService`, `GitService`, and `WorkflowController` logic.
    *   **Integration Tests:** VS Code Extension Tests (using `vscode-test`) to verify that commands open the expected Webviews and modify the Tree View.
    *   **Manual Verification:** Since the CLI is external, a `mock_cli.py` is used. Developers must verify that the extension correctly handles the mock's output (stdout streaming, exit codes).
*   **CI/CD:**
    *   GitHub Actions workflow to run `npm install`, `npm run compile`, and `npm test` on push.
    *   Linting using `eslint` to ensure code quality.
*   **Code Quality Gates:**
    *   No TypeScript compilation errors.
    *   All Unit Tests pass.
    *   Linter passes.
*   **Artifact Validation:**
    *   JSON Schemas (`schemas/`) are used to validate `todo.json` at runtime.
    *   Diagrams are manually reviewed in the generated documentation to ensure they match the implementation.

## 6. Glossary

*   **CLI:** The external Python script ("Type A") that performs the actual code generation.
*   **Artifacts:** Files generated by the CLI (`requirements.md`, `architecture.md`, `todo.json`) stored in the user's project folder.
*   **Webview:** A VS Code API feature allowing the display of HTML/CSS/JS content within an editor tab.
*   **TreeDataProvider:** The VS Code API interface for populating the Side Bar view.
*   **Gating:** The process of blocking progress to the next phase until a specific user action (Approval) is received.